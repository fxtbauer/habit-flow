<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard - HabitFlow</title>

    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>

    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: "Inter", Arial, sans-serif;
        background: #0d1117;
        color: #e6edf3;
      }

      h1 {
        margin-bottom: 5px;
      }

      button {
        padding: 10px 16px;
        background: #238636;
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        font-weight: 600;
        margin-bottom: 20px;
        transition: 0.2s;
      }

      button:hover {
        background: #2ea043;
      }

      .habit-card {
        background: #161b22;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 0 6px #0006;
      }

      .habit-card.completed {
        background: #1b2d1b;
        border-left: 4px solid #2ea043;
      }

      .actions {
        display: flex;
        gap: 10px;
      }

      .btn-ok {
        background: #238636;
        border-radius: 6px;
        padding: 6px 12px;
        color: white;
        cursor: pointer;
      }

      .btn-ok:hover {
        background: #2ea043;
      }

      .btn-del {
        background: #da3633;
        border-radius: 6px;
        padding: 6px 12px;
        color: white;
        cursor: pointer;
      }

      .btn-del:hover {
        background: #f85149;
      }

      .btn-edit {
        background: #3b82f6;
        border-radius: 6px;
        padding: 6px 12px;
        color: white;
        cursor: pointer;
      }

      .btn-edit:hover {
        background: #60a5fa;
      }

      .stats {
        margin-top: 15px;
        margin-bottom: 25px;
        background: #161b22;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 0 4px #0005;
      }

      .progress-bar {
        width: 100%;
        height: 12px;
        background: #0d1117;
        border-radius: 8px;
        margin: 8px 0;
        overflow: hidden;
      }

      .progress {
        height: 100%;
        background: #238636;
        border-radius: 8px;
        transition: width 0.3s ease;
      }
    </style>
  </head>

  <body x-data="dashboard()" x-init="init()">

    <h1>HabitFlow</h1>
    <p>Gerencie seus hábitos de forma simples e elegante</p>

    <div class="stats">
      <p x-text="`Hábitos concluídos: ${completedCount()} / ${habits.length}`"></p>

      <div class="progress-bar">
        <div class="progress" :style="`width: ${progressPercent()}%`"></div>
      </div>

      <p x-text="progressPercent() + '%'"></p>
    </div>

    <button @click="addHabit()">+ Novo Hábito</button>

    <template x-for="habit in habits" :key="habit.id">
      <div class="habit-card" :class="habit.completed ? 'completed' : ''">
        <strong x-text="habit.name"></strong>

        <div class="actions">
          <button class="btn-ok" @click="toggleHabit(habit)">✓</button>
          <button class="btn-edit" @click="editHabit(habit)">Editar</button>
          <button class="btn-del" @click="deleteHabit(habit.id)">X</button>
        </div>
      </div>
    </template>

    <script>
      function dashboard() {
        return {
          userId: null,
          habits: [],

          init() {
            const savedId = localStorage.getItem("userId");
            const role = localStorage.getItem("role");

            if (!savedId) {
              window.location.href = "/login";
              return;
            }

            if (role === "admin") {
              window.location.href = "/admin";
              return;
            }

            this.userId = savedId;
            this.loadHabits();
          },

          async loadHabits() {
            const res = await fetch(`/habits/${this.userId}`);
            this.habits = await res.json();
          },

          async addHabit() {
            const name = prompt("Nome do hábito:");
            if (!name) return;

            await fetch("/habits", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                userId: this.userId,
                name,
                completed: false,
              }),
            });

            this.loadHabits();
          },

          async toggleHabit(habit) {
            await fetch(`/habits/${habit.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                id: habit.id,
                userId: this.userId,
                name: habit.name,
                completed: !habit.completed,
              }),
            });

            this.loadHabits();
          },

          async deleteHabit(id) {
            await fetch(`/habits/${id}`, { method: "DELETE" });
            this.loadHabits();
          },

          async editHabit(habit) {
            const newName = prompt("Novo nome para o hábito:", habit.name);
            if (!newName.trim()) return;

            await fetch(`/habits/${habit.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                id: habit.id,
                userId: this.userId,
                name: newName,
                completed: habit.completed,
              }),
            });

            this.loadHabits();
          },

          completedCount() {
            return this.habits.filter((h) => h.completed).length;
          },

          progressPercent() {
            if (this.habits.length === 0) return 0;
            return Math.round((this.completedCount() / this.habits.length) * 100);
          },
          
          logout() {
            localStorage.removeItem("userId");
            localStorage.removeItem("role");
            window.location.href = "/login";
          },
        };
      }
    </script>
  </body>
</html>
