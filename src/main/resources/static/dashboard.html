<!DOCTYPE html>
<html lang="pt-br" x-data="dashboard()">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard - HabitFlow</title>

    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

    <style>
      body {
        font-family: Arial;
        padding: 20px;
        background: #fafafa;
      }

      .habit-card {
        padding: 10px;
        background: white;
        margin-bottom: 8px;
        border-radius: 8px;
        box-shadow: 0 0 5px #0002;
      }

      .completed {
        background: #d4edda !important;
        text-decoration: line-through;
      }

      button {
        padding: 10px 15px;
        background: #007bff;
        color: white;
        border-radius: 6px;
        border: none;
        cursor: pointer;
      }
    </style>
  </head>

  <!-- CARREGA HÁBITOS AO ENTRAR -->
  <body x-init="init()">
    <h1>Dashboard</h1>
    <p>Bem-vindo(a), <strong x-text="username"></strong>!</p>

    <button @click="logout()" style="background:#dc3545; margin-bottom:15px">
      Sair
    </button>

    <br />

    <button @click="addHabit()">Adicionar Hábito</button>

    <h2 style="margin-top: 20px">Seus hábitos:</h2>

    <!-- LISTA DE HÁBITOS -->
    <template x-for="habit in habits" :key="habit.id">
      <div class="habit-card" :class="habit.completed ? 'completed' : ''">
        <strong x-text="habit.name"></strong>

        <div style="display: flex; gap: 10px; margin-top: 6px">
          <!-- BOTÃO DE CHECK -->
          <button
            @click="toggleHabit(habit)"
            style="padding: 6px; background: #28a745">
            ✓
          </button>

          <!-- BOTÃO DE DELETE -->
          <button
            @click="deleteHabit(habit.id)"
            style="padding: 6px; background: #dc3545">
            X
          </button>
        </div>
      </div>
    </template>

    <script>
      function dashboard() {
        return {
          token: null,
          username: "",
          habits: [],

          // Inicializa dashboard
          init() {
            this.token = localStorage.getItem("token");

            if (!this.token) {
              window.location.href = "/login";
              return;
            }

            // Pega username salvo
            this.username = localStorage.getItem("username") || "Usuário";

            this.loadHabits();
          },

          // Carrega hábitos do usuário autenticado
          async loadHabits() {
            const res = await fetch("/habits", {
              headers: {
                Authorization: this.token
              }
            });

            if (res.status === 401) {
              this.logout();
              return;
            }

            this.habits = await res.json();
          },

          // Adiciona hábito
          async addHabit() {
            const name = prompt("Nome do hábito:");
            if (!name) return;

            await fetch("/habits", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: this.token
              },
              body: JSON.stringify({
                name: name,
                completed: false
              })
            });

            this.loadHabits();
          },

          // Alterna completed
          async toggleHabit(habit) {
            await fetch(`/habits/${habit.id}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: this.token
              },
              body: JSON.stringify({
                name: habit.name,
                completed: !habit.completed
              })
            });

            this.loadHabits();
          },

          // Delete hábito
          async deleteHabit(id) {
            await fetch(`/habits/${id}`, {
              method: "DELETE",
              headers: {
                Authorization: this.token
              }
            });

            this.loadHabits();
          },

          // Logout
          logout() {
            localStorage.clear();
            window.location.href = "/login";
          }
        };
      }
    </script>
  </body>
</html>
