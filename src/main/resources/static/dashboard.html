<!DOCTYPE html>
<html lang="pt-br" x-data="dashboard()">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard - HabitFlow</title>

    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>

    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: "Inter", Arial, sans-serif;
        background: #0d1117;
        color: #e6edf3;
      }

      h1 {
        margin-bottom: 5px;
      }

      button {
        padding: 10px 16px;
        background: #238636;
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        font-weight: 600;
        margin-bottom: 20px;
        transition: 0.2s;
      }

      button:hover {
        background: #2ea043;
      }

      .habit-card {
        background: #161b22;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 0 6px #0006;
      }

      .habit-card.completed {
        background: #1b2d1b;
        border-left: 4px solid #2ea043;
      }

      .actions {
        display: flex;
        gap: 10px;
      }

      .btn-ok {
        background: #238636;
        border-radius: 6px;
        padding: 6px 12px;
        color: white;
        cursor: pointer;
      }

      .btn-ok:hover {
        background: #2ea043;
      }

      .btn-del {
        background: #da3633;
        border-radius: 6px;
        padding: 6px 12px;
        color: white;
        cursor: pointer;
      }

      .btn-del:hover {
        background: #f85149;
      }

      .btn-edit {
        background: #3b82f6;
        border-radius: 6px;
        padding: 6px 12px;
        color: white;
        cursor: pointer;
      }

      .btn-edit:hover {
        background: #60a5fa;
      }
    </style>
  </head>

  <body x-init="init(); loadHabits()">
    <h1>HabitFlow</h1>
    <p>Gerencie seus hábitos de forma simples e elegante</p>

    <button @click="addHabit()">+ Novo Hábito</button>

    <template x-for="habit in habits" :key="habit.id">
      <div class="habit-card" :class="habit.completed ? 'completed' : ''">
        <strong x-text="habit.name"></strong>

        <div class="actions">
          <button class="btn-ok" @click="toggleHabit(habit)">✓</button>

          <button class="btn-edit" @click="editHabit(habit)">Editar</button>

          <button class="btn-del" @click="deleteHabit(habit.id)">X</button>
        </div>
      </div>
    </template>

    <script>
      function dashboard() {
        return {
          userId: null,
          habits: [],

          // Proteção de rota
          init() {
            const savedId = localStorage.getItem("userId");

            if (!savedId) {
              window.location.href = "/login";
              return;
            }

            this.userId = savedId;
          },

          // Carrega hábitos
          async loadHabits() {
            const res = await fetch(`/habits/${this.userId}`);
            this.habits = await res.json();
          },

          // Cria hábito
          async addHabit() {
            const name = prompt("Nome do hábito:");
            if (!name) return;

            await fetch("/habits", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                userId: this.userId,
                name,
                completed: false,
              }),
            });

            this.loadHabits();
          },

          // Alterna concluído
          async toggleHabit(habit) {
            await fetch(`/habits/${habit.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                id: habit.id,
                userId: this.userId,
                name: habit.name,
                completed: !habit.completed,
              }),
            });

            this.loadHabits();
          },

          // Deleta hábito
          async deleteHabit(id) {
            await fetch(`/habits/${id}`, {
              method: "DELETE",
            });

            this.loadHabits();
          },
          async editHabit(habit) {
            const newName = prompt("Novo nome para o hábito:", habit.name);
            if (!newName || newName.trim() === "") return;

            await fetch(`/habits/${habit.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                id: habit.id,
                userId: this.userId,
                name: newName,
                completed: habit.completed,
              }),
            });

            this.loadHabits();
          },

          // Logout
          logout() {
            localStorage.removeItem("userId");
            window.location.href = "/login";
          },
        };
      }
    </script>
  </body>
</html>
